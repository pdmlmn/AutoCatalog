<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Catalog Generator (Excel) - Improved</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Teko:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
        }
        /* A4 page style */
        .page {
            width: 210mm;
            height: 297mm; /* Fixed height to prevent footer from being pushed to the next page */
            padding: 10mm 15mm;
            margin: 1rem auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden; /* Prevent content overflow */
        }
        .page-header, .page-footer {
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        .page-content {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start; /* Align content from the top */
            gap: 15mm 10mm;
            padding: 10mm 10mm;
            overflow: hidden; /* Prevent content overflow */
        }
        
        /* Improved product card style */
        .product-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 250px;
            margin-bottom: 10px;
            break-inside: avoid;
            page-break-inside: avoid;
            font-family: 'Segoe Print', cursive; /* Reverted to original */
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }
        
        /* Optimization for different product counts */
        .page-content[data-product-count="7"],
        .page-content[data-product-count="8"],
        .page-content[data-product-count="9"] {
            gap: 2mm 8mm; /* Reduce vertical gap */
            padding: 5mm 10mm; /* Reduce padding */
        }
        
        /* Improved image style */
        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            object-position: center;
            border-radius: 4px;
            transition: transform 0.2s ease;
        }

        .product-image-area {
            background-color: white;
            border: 1px solid #e5e7eb;
            padding: 4px;
            border-radius: 6px;
            margin: 8px;
            position: relative; /* Needed for absolute positioning of children */
        }
        
        .product-details-area {
            background-color: white;
        }
        
        /* Style for failed image loading */
        .product-image[src*="placehold"] {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Improved price tag */
        .price-tag {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #B91C1C;
            color: #FFD700;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
            text-align: center;
            padding: 5px;
            transform: rotate(15deg);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 5;
            -webkit-print-color-adjust: exact;  
            print-color-adjust: exact;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .price-number {
            font-size: clamp(0.8rem, 2vw, 1.25rem);
            word-break: break-all;
        }
        
        .price-unit {
            font-size: clamp(0.6rem, 1.5vw, 0.875rem);
            margin-top: 2px;
        }
        
        .kampanj-font {
            font-family: 'Teko', sans-serif;
            text-transform: uppercase;
        }
        
        .product-name-container {
            height: auto;
            min-height: 36px;
            max-height: 54px; /* Allow two lines of text */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 2px 4px;
        }
        
        .product-name {
            font-weight: bold;
            font-size: 0.875rem;
            line-height: 1.2;  
            word-break: break-word;
            letter-spacing: -0.5px;
            text-align: center; /* Reverted to original */
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Improved remark tag */
        .remark-tag {
            max-width: 90%;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.1;
        }

        /* Brand and Origin Styles */
        .brand-origin-container { /* For Promotion Mode */
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            font-size: 12px;
            color: black;
            text-shadow: none;
        }
        .origin-container { /* For New Arrivals Mode */
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        .brand-tag { /* For New Arrivals Mode */
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 3;
            background-color: rgba(255, 255, 255, 0.85);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: black;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .origin-items-container {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        .origin-flag {
            width: 20px;
            height: auto;
            border-radius: 2px;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }

        /* Tab style */
        .tab {
            display: inline-block;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            background-color: #e2e8f0;
            margin-right: 4px;
            font-weight: 500;
        }
        
        .tab.active {
            background-color: #4f46e5;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Improved print style */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background-color: white !important;
                margin: 0;
            }
            
            .control-panel, .print-button-container, #auth-modal, #expired-modal {
                display: none !important;
            }
            
            #preview {
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
                transform: scale(1) !important; /* Reset zoom for printing */
            }
            
            .page {
                margin: 0;
                box-shadow: none;
                border: none;
                page-break-after: always;
                page-break-inside: avoid;
                height: 297mm;
            }
            
            .page:last-child {
                page-break-after: avoid;
            }
            
            .product-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            @page {
                size: A4;
                margin: 0;
            }
        }
        
        /* Loading state style */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced control panel style */
        .control-panel {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 12px;
            margin: 1rem;
            padding: 1.5rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        
        .control-panel h1 {
            color: #2d3748;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(79, 70, 229, 0.2);
        }
        
        .control-section {
            background: white;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        
        .control-section:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .control-section h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .control-section h2::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4f46e5;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .file-upload-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .file-upload-label:active {
            transform: translateY(0);
        }
        
        .file-info {
            display: inline-block;
            margin-left: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 4px;
            color: #4f46e5;
            font-size: 0.875rem;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background-color: white;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .rich-text-editor {
            height: 120px;
            overflow-y: auto;
        }

        .toolbar {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .toolbar-btn {
            border: 1px solid #d1d5db;
            background-color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .toolbar-btn:hover {
            background-color: #f3f4f6;
        }
        .toolbar-select {
             border: 1px solid #d1d5db;
            background-color: white;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
        }
        .toolbar-color {
            border: 1px solid #d1d5db;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            background-color: white;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .status-message {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
        }
        
        .status-message.info {
            background: rgba(66, 153, 225, 0.1);
            color: #2b6cb0;
            border-left: 4px solid #4299e1;
        }
        
        .status-message.success {
            background: rgba(47, 179, 123, 0.1);
            color: #2f855a;
            border-left: 4px solid #38a169;
        }
        
        .status-message.warning {
            background: rgba(237, 137, 54, 0.1);
            color: #c05621;
            border-left: 4px solid #ed8936;
        }
        
        .status-message.error {
            background: rgba(229, 62, 62, 0.1);
            color: #c53030;
            border-left: 4px solid #e53e3e;
        }
        
        .status-icon {
            margin-right: 0.75rem;
            font-weight: bold;
        }
        
        #downloadTemplateBtn {
            color: #4f46e5;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        #downloadTemplateBtn:hover {
            color: #7c3aed;
            text-decoration: underline;
        }

        #preview {
            transform-origin: top center;
            transition: transform 0.2s ease-in-out;
        }

        /* Password Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen">

    <!-- License Modal -->
    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4" data-lang-key="licenseTitle">Enter License Key</h2>
            <p class="text-gray-600 mb-4" data-lang-key="licensePrompt">Please enter your license key to continue.</p>
            <input type="text" id="license-input" class="input-field mb-4" data-lang-placeholder="licensePlaceholder" placeholder="XXXX-XXXX-XXXX-XXXX">
            <button id="submit-license" class="btn-primary" data-lang-key="activateButton">Activate</button>
            <p id="license-error" class="text-red-500 text-sm mt-2 hidden" data-lang-key="licenseError">Invalid license key, please try again.</p>
            <p class="text-xs text-gray-500 mt-4" data-lang-key="purchaseInfo">
                Don't have a license key? Please visit our website to purchase a commercial license.
            </p>
        </div>
    </div>

    <!-- Expired Modal -->
    <div id="expired-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-red-600" data-lang-key="expiredTitle">License Expired</h2>
            <p class="text-gray-600" data-lang-key="expiredText">Your license has expired. Please contact the administrator for a new license.</p>
        </div>
    </div>
    
    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="flex flex-col md:flex-row h-screen w-full hidden">
        <div class="control-panel w-full md:w-1/4 lg:w-1/5 bg-white shadow-lg overflow-y-auto">
            <h1 class="text-2xl font-bold" data-lang-key="appTitle">Catalog Generator</h1>
            <div class="my-4">
                <label for="language-selector" class="sr-only" data-lang-key="languageLabel">Language</label>
                <select id="language-selector" class="input-field">
                    <option value="en">English</option>
                    <option value="zh">中文</option>
                    <option value="sv">Svenska</option>
                </select>
            </div>
            
            <div class="space-y-6">
                <div class="control-section">
                    <h2 data-lang-key="step1Title">Step 1: Upload Product Information</h2>
                    <div class="flex items-center">
                        <label for="excelFile" class="file-upload-label" data-lang-key="chooseFile">
                            Choose File
                        </label>
                        <input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden">
                        <span id="excelFileName" class="file-info" data-lang-key="noFileChosen">No file chosen</span>
                    </div>
                    <button id="downloadTemplateBtn" class="mt-2 w-full text-sm" data-lang-key="downloadTemplate">Download Template</button>
                    <p class="mt-1 text-xs text-gray-500" data-lang-key="step1Desc">Use the 'page' column to assign products to specific pages. The tool will automatically adjust the layout for 1-9 products per page.</p>
                </div>

                <div class="control-section">
                    <h2 data-lang-key="step2Title">Step 2: Upload Product Pictures</h2>
                     <div class="flex items-center">
                        <label for="imageFiles" class="file-upload-label" data-lang-key="chooseFiles">
                            Choose Files
                        </label>
                        <input type="file" id="imageFiles" multiple accept="image/*" class="hidden">
                        <span id="imageFilesName" class="file-info" data-lang-key="noFilesChosen">No files chosen</span>
                    </div>
                    <p class="mt-1 text-xs text-gray-500" data-lang-key="step2Desc">Image filename must match 'SKU'. Recommended size 800x800 pixels, max 2MB.</p>
                </div>

                <div class="control-section">
                    <h2 data-lang-key="step3Title">Step 3: Customize Configuration</h2>
                    <input type="text" id="promoTime" class="input-field" data-lang-placeholder="promoDatePlaceholder" value="July 2025 Special">
                    
                    <div class="mt-2">
                        <div class="flex border-b border-gray-200">
                            <div class="tab active" data-tab="promotion" data-lang-key="promoTab">Promotion</div>
                            <div class="tab" data-tab="new-arrivals" data-lang-key="newArrivalsTab">New Arrivals</div>
                        </div>
                        
                        <div class="tab-content active" id="promotion-content">
                            <input type="text" id="promoText" class="mt-2 input-field" data-lang-placeholder="promoTitlePlaceholder" value="Kampanj">
                        </div>
                        
                        <div class="tab-content" id="new-arrivals-content">
                            <input type="text" id="newArrivalsText" class="mt-2 input-field" data-lang-placeholder="newArrivalsTitlePlaceholder" value="NYHETER">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h2 data-lang-key="footerTitle">Custom Footer Text</h2>
                    <div class="toolbar">
                        <button class="toolbar-btn" data-command="bold" title="Bold"><b>B</b></button>
                        <button class="toolbar-btn" data-command="italic" title="Italic"><i>I</i></button>
                        <button class="toolbar-btn" data-command="underline" title="Underline"><u>U</u></button>
                        <select id="fontNameSelect" class="toolbar-select" title="Font">
                            <option>Arial</option>
                            <option>Verdana</option>
                            <option>Georgia</option>
                            <option>Times New Roman</option>
                            <option>Courier New</option>
                        </select>
                        <select id="fontSizeSelect" class="toolbar-select" title="Font Size">
                            <option value="1" style="font-size: 8pt;">8pt</option>
                            <option value="2" style="font-size: 10pt;">10pt</option>
                            <option value="3" selected style="font-size: 12pt;">12pt</option>
                        </select>
                        <input type="color" id="fontColorPicker" class="toolbar-color" title="Font Color">
                    </div>
                    <div id="footerText" contenteditable="true" class="input-field rich-text-editor"><b>CTFOOD STOCKHOLM:</b> 08 581 658 80 | order.sth@ctfood.se | www.ctfood.se<br>Med reservation för slutförsäljning och tryckfel. Priserna är angivna svenska kronor exkl. moms. Leveransvillkor fritt vårt lager. Leveranstid: 1-3 dagar. Betalningsvillkor: 15 dagar netto efter godkänd sedvanlig kreditprovning</div>
                </div>

                <div class="control-section">
                    <h2 data-lang-key="appearanceTitle">Customize Appearance</h2>
                    <p class="mt-1 mb-2 text-xs text-gray-500" data-lang-key="appearanceDesc">Tip: Name origin flags after the country (e.g., Thailand.png). Other images: Header Logo (400x100), Header BG (600x100 recommended), Page BG (1240x1754), Price Tag (100x100), Footer (100x100).</p>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <label for="logoFile" class="file-upload-label" data-lang-key="headerLogo">Header Logo</label>
                            <input type="file" id="logoFile" accept="image/*" class="hidden">
                            <span id="logoFileName" class="file-info" data-lang-key="noFileChosen">No file chosen</span>
                        </div>
                        <div class="flex items-center">
                            <label for="headerBackgroundFile" class="file-upload-label" data-lang-key="headerBg">Header BG</label>
                            <input type="file" id="headerBackgroundFile" accept="image/*" class="hidden">
                            <span id="headerBackgroundFileName" class="file-info" data-lang-key="noFileChosen">No file chosen</span>
                        </div>
                        <div class="flex items-center">
                            <label for="backgroundFile" class="file-upload-label" data-lang-key="pageBg">Page BG</label>
                            <input type="file" id="backgroundFile" accept="image/*" class="hidden">
                            <span id="backgroundFileName" class="file-info" data-lang-key="noFileChosen">No file chosen</span>
                        </div>
                        <div class="flex items-center">
                            <label for="priceTagFile" class="file-upload-label" data-lang-key="priceTagBg">Price Tag BG</label>
                            <input type="file" id="priceTagFile" accept="image/*" class="hidden">
                            <span id="priceTagFileName" class="file-info" data-lang-key="noFileChosen">No file chosen</span>
                        </div>
                        <div class="flex items-center">
                            <label for="originFlagFiles" class="file-upload-label" data-lang-key="originFlags">Origin Flags</label>
                            <input type="file" id="originFlagFiles" accept="image/*" class="hidden" multiple>
                            <span id="originFlagFilesName" class="file-info" data-lang-key="noFilesChosen">No files chosen</span>
                        </div>
                        <div class="flex items-center">
                            <label for="footerLogoFile" class="file-upload-label" data-lang-key="footerImage">Footer Image</label>
                            <input type="file" id="footerLogoFile" accept="image/*" class="hidden">
                            <span id="footerLogoFileName" class="file-info" data-lang-key="noFileChosen">No file chosen</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h2 data-lang-key="zoomTitle">Zoom Preview</h2>
                <div class="flex items-center space-x-2">
                    <button id="zoomOutBtn" class="p-2 border rounded-md cursor-pointer">-</button>
                    <input type="range" id="zoomSlider" min="50" max="150" value="100" class="w-full cursor-pointer">
                    <button id="zoomInBtn" class="p-2 border rounded-md cursor-pointer">+</button>
                </div>
                <div class="text-center mt-1 text-sm text-gray-600"><span id="zoomValue">100</span>%</div>
            </div>

            <div id="status" class="mt-6 space-y-2"></div>

            <div class="print-button-container mt-6">
                 <button id="printBtn" class="btn-primary hidden" data-lang-key="printButton">
                    Print or Save as PDF
                </button>
            </div>
        </div>

        <div id="preview" class="flex-1 p-6 overflow-y-auto">
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Prevent Source Code Viewing ---
        // This is a deterrent, not a foolproof method.
        // Disable right-click context menu
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Disable keyboard shortcuts for developer tools
        document.addEventListener('keydown', event => {
            // F12
            if (event.keyCode === 123) {
                event.preventDefault();
            }
            // Ctrl+Shift+I
            if (event.ctrlKey && event.shiftKey && event.keyCode === 73) {
                event.preventDefault();
            }
            // Ctrl+Shift+J
            if (event.ctrlKey && event.shiftKey && event.keyCode === 74) {
                event.preventDefault();
            }
            // Ctrl+U
            if (event.ctrlKey && event.keyCode === 85) {
                event.preventDefault();
            }
        });
        // --- END: Prevent Source Code Viewing ---

        // --- START: Multi-language Support ---
        const translations = {
            en: {
                appTitle: "Catalog Generator",
                languageLabel: "Language",
                step1Title: "Step 1: Upload Product Information",
                chooseFile: "Choose File",
                chooseFiles: "Choose Files",
                noFileChosen: "No file chosen",
                noFilesChosen: "No files chosen",
                downloadTemplate: "Download Template",
                step1Desc: "Use the 'page' column to assign products to specific pages. The tool will automatically adjust the layout for 1-9 products per page.",
                step2Title: "Step 2: Upload Product Pictures",
                step2Desc: "Image filename must match 'SKU'. Recommended size 800x800 pixels, max 2MB.",
                step3Title: "Step 3: Customize Configuration",
                promoDatePlaceholder: "Promotion Date (e.g., May Special)",
                promoTab: "Promotion",
                newArrivalsTab: "New Arrivals",
                promoTitlePlaceholder: "Promotion Title (e.g., Kampanj)",
                newArrivalsTitlePlaceholder: "New Arrivals Title (e.g., NYHETER)",
                footerTitle: "Custom Footer Text",
                appearanceTitle: "Customize Appearance",
                appearanceDesc: "Tip: Name origin flags after the country (e.g., Thailand.png). Other images: Header Logo (400x100), Header BG (600x100 recommended), Page BG (1240x1754), Price Tag (100x100), Footer (100x100).",
                headerLogo: "Header Logo",
                headerBg: "Header BG",
                pageBg: "Page BG",
                priceTagBg: "Price Tag BG",
                originFlags: "Origin Flags",
                footerImage: "Footer Image",
                zoomTitle: "Zoom Preview",
                printButton: "Print or Save as PDF",
                licenseTitle: "Enter License Key",
                licensePrompt: "Please enter your license key to continue.",
                licensePlaceholder: "License Key",
                activateButton: "Activate",
                licenseError: "Invalid license key, please try again.",
                expiredTitle: "License Expired",
                expiredText: "Your license has expired. Please contact the administrator for a new license.",
                purchaseInfo: "Don't have a license key? Please visit our website to purchase a commercial license.",
                previewHeader: "Product Preview",
                previewText: "Please upload the Excel and image files on the left to begin.",
                statusParsingExcel: "Parsing Excel file...",
                statusParseSuccess: (count) => `Excel parsed successfully with ${count} products found.`,
                statusParseFailed: (error) => `Excel parsing failed with the following error: ${error}`,
                statusProcessingImages: "Processing images...",
                statusImagesSuccess: (processed, total) => `Images processed successfully: ${processed} out of ${total}`,
                statusImageProcessFailed: (name) => `Failed to process the following file: ${name}`,
                statusImageTooLarge: (name) => `The image ${name} is too large (over 2MB) and was skipped.`,
                statusImageCompressFailed: (name) => `Image compression failed for the file ${name}. Using the original file.`,
                statusRenderError: (error) => `The following rendering error occurred: ${error}`,
                statusUnknownError: "An unknown error occurred. Please check your files or refresh the page.",
                statusScriptError: "A script error occurred. Please refresh the page and try again.",
                statusTotalProducts: (total, matched) => `Total ${total} products, found ${matched} matching images.`,
                statusMissingImages: (skus) => `Missing images for the following SKUs: ${skus}`
            },
            zh: {
                appTitle: "产品目录生成器",
                languageLabel: "语言",
                step1Title: "第一步：上传产品信息",
                chooseFile: "选择文件",
                chooseFiles: "选择多个文件",
                noFileChosen: "未选择文件",
                noFilesChosen: "未选择文件",
                downloadTemplate: "下载模板",
                step1Desc: "使用 'page' 列将产品分配到特定页面。工具将自动为每页1-9个产品调整布局。",
                step2Title: "第二步：上传产品图片",
                step2Desc: "图片文件名必须与'SKU'匹配。推荐尺寸800x800像素，最大2MB。",
                step3Title: "第三步：自定义配置",
                promoDatePlaceholder: "促销日期 (例如, 五月特惠)",
                promoTab: "促销",
                newArrivalsTab: "新品",
                promoTitlePlaceholder: "促销标题 (例如, Kampanj)",
                newArrivalsTitlePlaceholder: "新品标题 (例如, NYHETER)",
                footerTitle: "自定义页脚文本",
                appearanceTitle: "自定义外观",
                appearanceDesc: "提示：将原产地旗帜命名为国家名 (例如, Thailand.png)。其他图片：页眉Logo (400x100), 页眉背景 (推荐600x100), 页面背景 (1240x1754), 价格标签 (100x100), 页脚 (100x100)。",
                headerLogo: "页眉Logo",
                headerBg: "页眉背景",
                pageBg: "页面背景",
                priceTagBg: "价格标签背景",
                originFlags: "原产地旗帜",
                footerImage: "页脚图片",
                zoomTitle: "缩放预览",
                printButton: "打印或另存为PDF",
                licenseTitle: "输入许可证密钥",
                licensePrompt: "请输入您的许可证密钥以继续使用。",
                licensePlaceholder: "许可证密钥",
                activateButton: "激活",
                licenseError: "许可证密钥无效，请重试。",
                expiredTitle: "许可证已过期",
                expiredText: "您的许可证已过期。请联系管理员以获取新的许可证。",
                purchaseInfo: "还没有许可证密钥？请访问我们的网站购买商业授权。",
                previewHeader: "产品预览",
                previewText: "请在左侧上传Excel和图片文件以开始。",
                statusParsingExcel: "正在解析Excel文件...",
                statusParseSuccess: (count) => `Excel解析成功，找到 ${count} 个产品。`,
                statusParseFailed: (error) => `Excel解析失败: ${error}`,
                statusProcessingImages: "正在处理图片...",
                statusImagesSuccess: (processed, total) => `图片处理成功: ${processed} / ${total}`,
                statusImageProcessFailed: (name) => `处理文件失败: ${name}`,
                statusImageTooLarge: (name) => `图片 ${name} 太大 (超过2MB)，已跳过。`,
                statusImageCompressFailed: (name) => `图片压缩失败: ${name}。使用原始文件。`,
                statusRenderError: (error) => `渲染时发生错误: ${error}`,
                statusUnknownError: "发生未知错误。请检查您的文件或刷新页面。",
                statusScriptError: "发生脚本错误。请刷新页面重试。",
                statusTotalProducts: (total, matched) => `共 ${total} 个产品，找到 ${matched} 张匹配图片。`,
                statusMissingImages: (skus) => `以下SKU缺少图片: ${skus}`
            },
            sv: {
                appTitle: "Kataloggenerator",
                languageLabel: "Språk",
                step1Title: "Steg 1: Ladda upp produktinformation",
                chooseFile: "Välj fil",
                chooseFiles: "Välj filer",
                noFileChosen: "Ingen fil vald",
                noFilesChosen: "Inga filer valda",
                downloadTemplate: "Ladda ner mall",
                step1Desc: "Använd 'page'-kolumnen för att tilldela produkter till specifika sidor. Verktyget justerar automatiskt layouten för 1-9 produkter per sida.",
                step2Title: "Steg 2: Ladda upp produktbilder",
                step2Desc: "Bildens filnamn måste matcha 'SKU'. Rekommenderad storlek 800x800 pixlar, max 2MB.",
                step3Title: "Steg 3: Anpassa konfiguration",
                promoDatePlaceholder: "Kampanjdatum (t.ex. Maj-special)",
                promoTab: "Kampanj",
                newArrivalsTab: "Nyheter",
                promoTitlePlaceholder: "Kampanjtitel (t.ex. Kampanj)",
                newArrivalsTitlePlaceholder: "Nyhetstitel (t.ex. NYHETER)",
                footerTitle: "Anpassad sidfotstext",
                appearanceTitle: "Anpassa utseende",
                appearanceDesc: "Tips: Namnge ursprungsflaggor efter landet (t.ex. Thailand.png). Andra bilder: Sidhuvud-logotyp (400x100), Sidhuvud-bakgrund (600x100 rekommenderas), Sidbakgrund (1240x1754), Prislapp (100x100), Sidfot (100x100).",
                headerLogo: "Sidhuvud-logotyp",
                headerBg: "Sidhuvud BG",
                pageBg: "Sidbakgrund",
                priceTagBg: "Prislapp BG",
                originFlags: "Ursprungsflaggor",
                footerImage: "Sidfotsbild",
                zoomTitle: "Zooma förhandsgranskning",
                printButton: "Skriv ut eller spara som PDF",
                licenseTitle: "Ange licensnyckel",
                licensePrompt: "Vänligen ange din licensnyckel för att fortsätta.",
                licensePlaceholder: "Licensnyckel",
                activateButton: "Aktivera",
                licenseError: "Ogiltig licensnyckel, försök igen.",
                expiredTitle: "Licensen har gått ut",
                expiredText: "Din licens har gått ut. Vänligen kontakta administratören för en ny licens.",
                purchaseInfo: "Har du ingen licensnyckel? Besök vår webbplats för att köpa en kommersiell licens。",
                previewHeader: "Produktförhandsgranskning",
                previewText: "Vänligen ladda upp Excel- och bildfilerna till vänster för att börja.",
                statusParsingExcel: "Analyserar Excel-fil...",
                statusParseSuccess: (count) => `Excel analyserades framgångsrikt med ${count} produkter hittade.`,
                statusParseFailed: (error) => `Excel-analys misslyckades med följande fel: ${error}`,
                statusProcessingImages: "Bearbetar bilder...",
                statusImagesSuccess: (processed, total) => `Bilder bearbetade framgångsrikt: ${processed} av ${total}`,
                statusImageProcessFailed: (name) => `Misslyckades med att bearbeta följande fil: ${name}`,
                statusImageTooLarge: (name) => `Bilden ${name} är för stor (över 2MB) och hoppades över.`,
                statusImageCompressFailed: (name) => `Bildkomprimering misslyckades för filen ${name}. Använder originalfilen.`,
                statusRenderError: (error) => `Följande renderingsfel inträffade: ${error}`,
                statusUnknownError: "Ett okänt fel inträffade. Kontrollera dina filer eller uppdatera sidan.",
                statusScriptError: "Ett skriptfel inträffade. Uppdatera sidan och försök igen.",
                statusTotalProducts: (total, matched) => `Totalt ${total} produkter, hittade ${matched} matchande bilder.`,
                statusMissingImages: (skus) => `Saknar bilder för följande SKU:er: ${skus}`
            }
        };

        let currentLang = localStorage.getItem('language') || 'en';
        let userHasUploaded = false; // Flag to check if user has uploaded their own files

        const languageSelector = document.getElementById('language-selector');

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;
            languageSelector.value = lang;

            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    const translation = translations[lang][key];
                    if (typeof translation === 'function') {
                        // Functions are used for dynamic status messages, handle them elsewhere
                    } else {
                        el.textContent = translation;
                    }
                }
            });
            
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            
            // Re-render preview to update placeholder text if visible
            renderPreview();
        }

        languageSelector.addEventListener('change', (e) => {
            setLanguage(e.target.value);
        });

        // --- END: Multi-language Support ---

        // --- START: License-based Authentication Logic ---
        const authModal = document.getElementById('auth-modal');
        const expiredModal = document.getElementById('expired-modal');
        const appWrapper = document.getElementById('app-wrapper');
        const licenseInput = document.getElementById('license-input');
        const submitLicenseBtn = document.getElementById('submit-license');
        const licenseError = document.getElementById('license-error');

        // License validation function
        function validateLicense(licenseKey) {
            // Simple validation - in a real application, this would be more complex
            // and involve server-side verification
            const licensePattern = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
            return licensePattern.test(licenseKey);
        }

        function checkAccess() {
            const licenseData = localStorage.getItem('licenseData');
            const activationDateStr = localStorage.getItem('activationDate');

            if (licenseData && activationDateStr) {
                const activationDate = new Date(parseInt(activationDateStr));
                const now = new Date();
                const daysPassed = (now.getTime() - activationDate.getTime()) / (1000 * 3600 * 24);
                const EXPIRATION_DAYS = 365; // 1 year expiration

                if (daysPassed > EXPIRATION_DAYS) {
                    // Expired
                    expiredModal.classList.remove('hidden');
                    appWrapper.classList.add('hidden');
                } else {
                    // Access granted
                    appWrapper.classList.remove('hidden');
                    authModal.classList.add('hidden');
                    loadInitialPreview();
                }
            } else {
                // First time use, ask for license
                authModal.classList.remove('hidden');
                appWrapper.classList.add('hidden');
            }
        }

        submitLicenseBtn.addEventListener('click', () => {
            const licenseKey = licenseInput.value.trim().toUpperCase();
            
            if (validateLicense(licenseKey)) {
                // Valid license, set activation date
                localStorage.setItem('licenseData', licenseKey);
                localStorage.setItem('activationDate', Date.now().toString());
                authModal.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                licenseError.classList.add('hidden');
                loadInitialPreview();
            } else {
                // Invalid license
                licenseError.classList.remove('hidden');
            }
        });
        
        licenseInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                submitLicenseBtn.click();
            }
            
            // Auto-format license key as XXXX-XXXX-XXXX-XXXX
            const value = licenseInput.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            let formatted = '';
            for (let i = 0; i < value.length && i < 16; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += '-';
                }
                formatted += value[i];
            }
            licenseInput.value = formatted;
        });

        // --- END: License-based Authentication Logic ---


        // Global variables to store data
        let productData = [];
        let productImages = {};
        let originImages = {};
        let backgroundUrl = '';
        let logoUrl = '';
        let priceTagUrl = '';
        let footerLogoUrl = '';
        let headerBackgroundUrl = '';
        let currentTab = 'promotion';

        // --- START: Sample Data ---
        const sampleProductData = [
            { page: 1, sku: '1001', name: 'Instant Noodles', size: '5-pack', brand: 'Sample Brand', origin: 'China', price: 15.50, bbd: '2025-12-31', unit: 'pack', remark: 'Hot Sale' },
            { page: 1, sku: '1002', name: 'Organic Soy Sauce', size: '500ml', brand: 'Sample Brand', origin: 'Japan', price: 32.00, bbd: '2026-06-30', unit: 'bottle', remark: '' },
            { page: 1, sku: '1003', name: 'Thai Jasmine Rice', size: '5kg', brand: 'Golden Elephant', origin: 'Thailand', price: 125.00, bbd: '2026-01-15', unit: 'bag', remark: 'New' },
            { page: 1, sku: '1004', name: 'Korean Kimchi', size: '1kg', brand: 'Jongga', origin: 'Korea', price: 55.90, bbd: '2025-10-20', unit: 'jar', remark: '' },
        ];
        const sampleProductImages = {
            '1001': 'https://placehold.co/800x800/f87171/ffffff?text=Noodles',
            '1002': 'https://placehold.co/800x800/fbbf24/ffffff?text=Soy+Sauce',
            '1003': 'https://placehold.co/800x800/34d399/ffffff?text=Rice',
            '1004': 'https://placehold.co/800x800/ef4444/ffffff?text=Kimchi',
        };
        const sampleOriginImages = {
            'China': 'https://placehold.co/40x30/ef4444/ffffff?text=CN',
            'Japan': 'https://placehold.co/40x30/ffffff/ef4444?text=JP',
            'Thailand': 'https://placehold.co/40x30/3b82f6/ffffff?text=TH',
            'Korea': 'https://placehold.co/40x30/6366f1/ffffff?text=KR',
        };
        // --- END: Sample Data ---
        
        function loadInitialPreview() {
            if (!userHasUploaded) {
                productData = sampleProductData;
                productImages = sampleProductImages;
                originImages = sampleOriginImages;
                // You can also set sample URLs for logo, background etc. if you want
                // logoUrl = 'https://placehold.co/400x100/cccccc/333333?text=Your+Logo';
                renderPreview();
            }
        }


        // DOM element references
        const excelFileInput = document.getElementById('excelFile');
        const imageFilesInput = document.getElementById('imageFiles');
        const backgroundFileInput = document.getElementById('backgroundFile');
        const logoFileInput = document.getElementById('logoFile');
        const priceTagFileInput = document.getElementById('priceTagFile');
        const originFlagFilesInput = document.getElementById('originFlagFiles');
        const footerLogoFileInput = document.getElementById('footerLogoFile');
        const headerBackgroundFileInput = document.getElementById('headerBackgroundFile');
        const promoTimeInput = document.getElementById('promoTime');
        const promoTextInput = document.getElementById('promoText');
        const newArrivalsTextInput = document.getElementById('newArrivalsText');
        const footerTextInput = document.getElementById('footerText');
        const printBtn = document.getElementById('printBtn');
        const previewArea = document.getElementById('preview');
        const statusDiv = document.getElementById('status');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        
        // Tab elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Zoom controls
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValueSpan = document.getElementById('zoomValue');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        
        // Tab switching functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                currentTab = tabName;
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-content`).classList.add('active');
                renderPreview();
            });
        });

        // --- Start of Zoom Functionality ---
        function updateZoom(value) {
            const zoomLevel = Math.max(50, Math.min(150, value)); // Clamp value between 50 and 150
            if (previewArea) previewArea.style.transform = `scale(${zoomLevel / 100})`;
            if (zoomValueSpan) zoomValueSpan.textContent = zoomLevel;
            if (zoomSlider) zoomSlider.value = zoomLevel;
        }

        if (zoomSlider) {
            zoomSlider.addEventListener('input', (e) => {
                updateZoom(parseInt(e.target.value, 10));
            });
        }

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', () => {
                const currentZoom = parseInt(zoomSlider.value, 10);
                updateZoom(currentZoom + 10);
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', () => {
                const currentZoom = parseInt(zoomSlider.value, 10);
                updateZoom(currentZoom - 10);
            });
        }
        // --- End of Zoom Functionality ---

        // Rich text editor toolbar
        const toolbar = document.querySelector('.toolbar');
        const fontNameSelect = document.getElementById('fontNameSelect');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        const fontColorPicker = document.getElementById('fontColorPicker');

        toolbar.addEventListener('click', (e) => {
            const command = e.target.closest('[data-command]')?.dataset.command;
            if (command) {
                 e.preventDefault();
                 document.execCommand(command, false, null);
                 footerTextInput.focus();
            }
        });

        fontNameSelect.addEventListener('change', (e) => {
            document.execCommand('fontName', false, e.target.value);
            footerTextInput.focus();
        });

        // 修复字体大小处理函数
        fontSizeSelect.addEventListener('change', (e) => {
            // 使用styleWithCSS来应用实际的字体大小
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('fontSize', false, e.target.value);
            document.execCommand('styleWithCSS', false, false);
            footerTextInput.focus();
        });

        fontColorPicker.addEventListener('input', (e) => {
            document.execCommand('foreColor', false, e.target.value);
            footerTextInput.focus();
        });
        
        function getTranslation(key, ...args) {
            const langPack = translations[currentLang] || translations.en;
            const translation = langPack[key];
            if (typeof translation === 'function') {
                return translation(...args);
            }
            return translation || key;
        }
        
        function addStatusMessage(key, type = 'info', ...args) {
            if (!statusDiv) return;
            const text = getTranslation(key, ...args);
            const div = document.createElement('div');
            const typeClasses = {
                error: 'status-message error',
                success: 'status-message success',
                warning: 'status-message warning',
                info: 'status-message info'
            };
            const icons = { error: '⚠', success: '✓', warning: '⚠', info: 'ℹ' };
            div.className = typeClasses[type] || typeClasses.info;
            div.innerHTML = `<span class="status-icon">${icons[type] || icons.info}</span>${text}`;
            statusDiv.appendChild(div);
        }
        
        function clearStatus() {
            if (statusDiv) statusDiv.innerHTML = '';
        }
        
        window.addEventListener('unhandledrejection', event => {
            console.error('Unhandled Rejection:', event.reason);
            addStatusMessage('statusUnknownError', 'error');
        });

        window.onerror = (message, source, lineno, colno, error) => {
            console.error('Global Error:', { message, source, lineno, colno, error });
            addStatusMessage('statusScriptError', 'error');
        };

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function adjustNameFontSizes() {
            document.querySelectorAll('.product-name-container').forEach(container => {
                const nameElement = container.querySelector('.product-name');
                if (!nameElement) return;
                nameElement.style.fontSize = '0.875rem';
                let currentFontSize = 14;
                while (nameElement.scrollHeight > container.clientHeight && currentFontSize > 8) {
                    currentFontSize--;
                    nameElement.style.fontSize = currentFontSize + 'px';
                }
            });
        }

        function adjustPriceFontSizes() {
            document.querySelectorAll('.price-tag').forEach(container => {
                const priceNumber = container.querySelector('.price-number');
                if (!priceNumber) return;
                priceNumber.style.fontSize = '1.25rem';
                let currentFontSize = 20;
                while (priceNumber.scrollWidth > container.clientWidth * 0.85 && currentFontSize > 10) {
                    currentFontSize--;
                    priceNumber.style.fontSize = currentFontSize + 'px';
                }
            });
        }
        
        function adjustRemarkFontSizes() {
            document.querySelectorAll('.remark-tag').forEach(remarkElement => {
                const container = remarkElement.parentElement;
                if (!container) return;
                remarkElement.style.fontSize = '0.75rem';
                let currentFontSize = 12;
                while (remarkElement.scrollWidth > container.clientWidth * 0.85 && currentFontSize > 8) {
                    currentFontSize--;
                    remarkElement.style.fontSize = currentFontSize + 'px';
                }
            });
        }

        function formatPrice(price) {
            const num = parseFloat(price || 0);
            return num.toFixed(2).replace('.', ',');
        }

        function normalizeData(data) {
            const filteredData = data.filter(row => (row.SKU || row.sku) && String(row.SKU || row.sku).trim() !== '');
            const standardKeys = ['page', 'sku', 'name', 'size', 'brand', 'origin', 'price', 'bbd', 'unit', 'remark'];
            return filteredData.map(row => {
                const newRow = {};
                const rowKeys = Object.keys(row);
                for (const stdKey of standardKeys) {
                    const foundKey = rowKeys.find(rowKey => rowKey.toLowerCase() === stdKey);
                    newRow[stdKey] = foundKey ? row[foundKey] : '';
                }
                return newRow;
            });
        }

        const renderPreview = () => {
            if (productData.length === 0 && userHasUploaded) {
                const header = getTranslation('previewHeader');
                const text = getTranslation('previewText');
                previewArea.innerHTML = `<div class="flex items-center justify-center h-full border-2 border-dashed border-gray-300 rounded-lg"><div class="text-center"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-900">${header}</h3><p class="mt-1 text-sm text-gray-500">${text}</p></div></div>`;
                printBtn.classList.add('hidden');
                clearStatus();
                return;
            }

            previewArea.classList.add('loading');
            
            setTimeout(() => {
                try {
                    previewArea.innerHTML = '';
                    clearStatus();

                    let matchedCount = 0;
                    const missingImages = [];
                    productData.forEach(product => {
                        const productCode = product['sku'];
                        if (productImages[productCode]) matchedCount++;
                        else missingImages.push(productCode);
                    });

                    if (userHasUploaded) {
                        addStatusMessage('statusTotalProducts', 'info', productData.length, matchedCount);
                        if (missingImages.length > 0) {
                            addStatusMessage('statusMissingImages', 'error', missingImages.join(', '));
                        }
                    }


                    const promoTime = promoTimeInput.value;
                    const isPriceHidden = currentTab === 'new-arrivals';
                    const newArrivalsText = newArrivalsTextInput.value || 'New Arrivals';
                    const promoText = currentTab === 'promotion' ? (promoTextInput.value || 'Kampanj') : newArrivalsText;
                    const totalPages = productData.reduce((max, p) => Math.max(max, parseInt(p.page) || 0), 0);

                    for (let i = 1; i <= totalPages; i++) {
                        const pageProducts = productData.filter(p => parseInt(p.page) === i);
                        if (pageProducts.length === 0) continue;

                        const page = document.createElement('div');
                        page.className = 'page';
                        if (backgroundUrl) page.style.backgroundImage = `url(${backgroundUrl})`;

                        const header = document.createElement('div');
                        header.className = 'page-header flex items-stretch pb-4 border-b border-gray-300';

                        // Logo part (1/4)
                        const logoContainer = document.createElement('div');
                        logoContainer.className = 'w-1/4 pr-4 flex items-center';
                        logoContainer.innerHTML = logoUrl ? `<img src="${logoUrl}" alt="Company Logo" style="max-height: 80px; max-width: 100%; object-fit: contain;">` : `<div><h2 class="text-3xl font-bold text-black">CTFOOD</h2><p class="text-sm text-gray-700">Orienten nära till hands</p></div>`;

                        // Right part (3/4)
                        const rightContainer = document.createElement('div');
                        rightContainer.className = 'w-3/4 text-right flex flex-col justify-center p-4 rounded';
                        
                        if (headerBackgroundUrl) {
                            rightContainer.style.backgroundImage = `url(${headerBackgroundUrl})`;
                            rightContainer.style.backgroundSize = 'auto';
                            rightContainer.style.backgroundRepeat = 'no-repeat';
                            rightContainer.style.backgroundPosition = 'center';
                        }
                        
                        const promoTextColor = headerBackgroundUrl ? 'text-white' : 'text-red-600';
                        const timeTextColor = headerBackgroundUrl ? 'text-white' : 'text-gray-800';
                        const textShadow = headerBackgroundUrl ? 'text-shadow: 1px 1px 3px rgba(0,0,0,0.7);' : '';

                        rightContainer.innerHTML = `
                            <h3 class="kampanj-font text-5xl ${promoTextColor} leading-none" style="${textShadow}">${promoText}</h3>
                            <p class="font-semibold ${timeTextColor}" style="${textShadow}">${promoTime}</p>
                        `;

                        header.appendChild(logoContainer);
                        header.appendChild(rightContainer);

                        const content = document.createElement('div');
                        content.className = 'page-content';
                        const numProducts = pageProducts.length;
                        content.setAttribute('data-product-count', numProducts);
                        
                        let cardHeight, cardWidth;
                        if (numProducts === 1) { cardWidth = '60%'; cardHeight = '500px'; } 
                        else if (numProducts === 2) { cardWidth = 'calc(50% - 5mm)'; cardHeight = '400px'; } 
                        else if (numProducts === 3) { cardWidth = 'calc(33.333% - 7mm)'; cardHeight = '380px'; } 
                        else if (numProducts === 4) { cardWidth = 'calc(50% - 5mm)'; cardHeight = '350px'; } 
                        else if (numProducts <= 6) { cardWidth = 'calc(33.333% - 7mm)'; cardHeight = '300px'; } 
                        else { cardWidth = 'calc(33.333% - 7mm)'; cardHeight = '160px'; }

                        pageProducts.forEach(product => {
                            const card = document.createElement('div');
                            card.className = 'product-card';
                            card.style.width = cardWidth;
                            card.style.height = cardHeight;
                            
                            const imageUrl = productImages[product['sku']] || 'https://placehold.co/200x200/e2e8f0/333333?text=No Image';
                            const bbdValue = product['bbd'];
                            const bbdOnImageHTML = bbdValue ? `<div class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-[10px] px-1.5 py-0.5 rounded">BBD: ${bbdValue}</div>` : '';
                            const remarkValue = product['remark'];
                            const remarkOnImageHTML = remarkValue ? `<div class="remark-tag absolute bottom-1 right-1 bg-black bg-opacity-60 text-yellow-300 text-xs font-bold px-3 py-1 rounded whitespace-nowrap">${remarkValue}</div>` : ``;

                            if (currentTab === 'new-arrivals') {
                                card.style.fontFamily = "'Calibri', sans-serif";
                                
                                const brand = product['brand'] || '';
                                const brandHTML = brand ? `<div class="brand-tag">${brand}</div>` : '';

                                const originValue = product['origin'] || '';
                                let originFlagsHTML = '';
                                if (originValue) {
                                    const origins = originValue.split(',').map(o => o.trim());
                                    const originElements = origins.map(origin => {
                                        const imageKey = Object.keys(originImages).find(k => k.toLowerCase() === origin.toLowerCase());
                                        const originImageUrl = imageKey ? originImages[imageKey] : null;
                                        if (originImageUrl) {
                                            return `<img src="${originImageUrl}" alt="${origin}" class="origin-flag" title="${origin}">`;
                                        }
                                        return '';
                                    }).filter(Boolean).join('');
                                    originFlagsHTML = `<div class="origin-items-container">${originElements}</div>`;
                                }
                                const originContainerHTML = `<div class="origin-container">${originFlagsHTML}</div>`;
                                const originText = product['origin'] || '';

                                card.innerHTML = `
                                    <div class="flex-grow flex flex-col min-h-0">
                                        <div class="product-image-area" style="flex-basis: 65%;">
                                            ${brandHTML}
                                            ${originContainerHTML}
                                            <div class="absolute inset-0 flex items-center justify-center p-2">
                                                <img src="${imageUrl}" alt="${product['name']}" class="product-image" onerror="this.src='https://placehold.co/200x200/e2e8f0/333333?text=Image failed to load'">
                                                ${bbdOnImageHTML}
                                                ${remarkOnImageHTML}
                                            </div>
                                        </div>
                                        <div class="product-details-area flex flex-col justify-center mx-4 py-1" style="flex-basis: 35%;">
                                            <div class="text-left space-y-1">
                                                <h3 class="product-name" style="text-align: left;" title="${product['name']}">${product['name'] || ''}</h3>
                                                <p class="text-sm text-gray-800" title="#${product['sku']}: ${product['size'] || ''}">#${product['sku'] || ''}: ${product['size'] || ''}</p>
                                                <p class="text-xs text-gray-600 truncate" title="Origin: ${originText}">${originText}</p>
                                            </div>
                                        </div>
                                    </div>`;
                            } else { // Promotion Mode
                                card.style.fontFamily = "'Segoe Print', cursive";

                                const price = formatPrice(product['price']);
                                const unit = product['unit'] || '';
                                const priceTagStyle = priceTagUrl ? `style="background-image: url('${priceTagUrl}'); background-color: transparent;"` : '';
                                const priceTagHTML = `<div class="price-tag" ${priceTagStyle}><div class="price-number">${price}</div><div class="price-unit">${unit ? `/${unit}` : ''}</div></div>`;

                                const brand = product['brand'] || '';
                                const originValue = product['origin'] || '';
                                let originDisplayHTML = '';

                                if (originValue) {
                                    const origins = originValue.split(',').map(o => o.trim());
                                    const originElements = origins.map(origin => {
                                        const imageKey = Object.keys(originImages).find(k => k.toLowerCase() === origin.toLowerCase());
                                        const originImageUrl = imageKey ? originImages[imageKey] : null;
                                        if (originImageUrl) {
                                            return `<img src="${originImageUrl}" alt="${origin}" class="origin-flag" title="${origin}">`;
                                        } else {
                                            return `<span class="origin-text">${origin}</span>`;
                                        }
                                    }).join('');
                                    originDisplayHTML = `<div class="origin-items-container">${originElements}</div>`;
                                }
                                
                                const brandAndOriginHTML = `<div class="brand-origin-container">${brand ? `<h4 class="font-semibold">${brand}</h4>` : ''}${originDisplayHTML}</div>`;

                                card.innerHTML = `
                                    ${priceTagHTML}
                                    <div class="flex-grow flex flex-col min-h-0">
                                        <div class="product-image-area" style="flex-basis: 65%;">
                                            ${brandAndOriginHTML}
                                            <div class="absolute inset-0 flex items-center justify-center p-2">
                                                <img src="${imageUrl}" alt="${product['name']}" class="product-image" onerror="this.src='https://placehold.co/200x200/e2e8f0/333333?text=Image failed to load'">
                                                ${bbdOnImageHTML}
                                                ${remarkOnImageHTML}
                                            </div>
                                        </div>
                                        <div class="product-details-area flex flex-col justify-between text-center p-2" style="flex-basis: 35%;">
                                            <div class="flex-grow">
                                                <p class="text-sm font-bold text-black underline truncate" style="letter-spacing: -0.5px;" title="${product['sku']}">${product['sku'] || ''}</p>
                                                <div class="product-name-container">
                                                    <h3 class="product-name" style="text-align: center;" title="${product['name']}">${product['name'] || ''}</h3>
                                                </div>
                                                <p class="text-xs text-gray-600 truncate" style="letter-spacing: -0.5px;" title="${product['size']}">${product['size'] || ''}</p>
                                            </div>
                                        </div>
                                    </div>`;
                            }
                            content.appendChild(card);
                        });

                        const footer = document.createElement('div');
                        footer.className = 'page-footer mt-auto pt-4 border-t border-gray-300';
                        const footerTextValue = footerTextInput.innerHTML;
                        const footerTextHTML = `<div class="text-[10px] text-gray-600 leading-relaxed">${footerTextValue}</div>`;
                        const footerMainContentHTML = footerLogoUrl ? `<div class="flex items-center"><div class="w-1/4 flex justify-center items-center pr-4"><img src="${footerLogoUrl}" alt="Footer Logo" class="flex-shrink-0" style="width: 100%; height: auto; max-height: 60px; object-fit: contain;"></div><div class="w-3/4 text-left">${footerTextHTML}</div></div>` : `<div class="text-center">${footerTextHTML}</div>`;
                        footer.innerHTML = `${footerMainContentHTML}<p class="text-xs mt-2 text-center text-gray-400">${i} / ${totalPages}</p>`;

                        page.appendChild(header);
                        page.appendChild(content);
                        page.appendChild(footer);
                        previewArea.appendChild(page);
                    }

                    previewArea.classList.remove('loading');
                    setTimeout(() => {
                        if (currentTab === 'promotion') {
                           adjustNameFontSizes();
                        }
                        adjustPriceFontSizes();
                        adjustRemarkFontSizes();
                    }, 100);
                    printBtn.classList.remove('hidden');
                } catch (error) {
                    console.error('Rendering error:', error);
                    previewArea.classList.remove('loading');
                    addStatusMessage('statusRenderError', 'error', error.message);
                }
            }, 50);
        };
        
        async function handleImageUpload(file, skipCompression = false) {
            userHasUploaded = true;
            if (skipCompression) {
                return URL.createObjectURL(file);
            }
            if (file.size > 2 * 1024 * 1024) {
                addStatusMessage('statusImageTooLarge', 'error', file.name);
                return null;
            }
            const options = { maxSizeMB: 1, maxWidthOrHeight: 800, useWebWorker: false };
            try {
                if (typeof imageCompression === 'undefined') {
                    console.warn('imageCompression library not loaded. Skipping compression.');
                    return URL.createObjectURL(file);
                }
                const compressedFile = await imageCompression(file, options);
                return URL.createObjectURL(compressedFile);
            } catch (error) {
                console.error("Image compression error: ", error);
                addStatusMessage('statusImageCompressFailed', 'warning', file.name);
                return URL.createObjectURL(file);
            }
        }

        excelFileInput.addEventListener('change', (event) => {
            userHasUploaded = true;
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('excelFileName').textContent = getTranslation('noFileChosen');
                return;
            }
            document.getElementById('excelFileName').textContent = file.name;
            clearStatus();
            addStatusMessage('statusParsingExcel', 'info');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    productData = normalizeData(jsonData);
                    addStatusMessage('statusParseSuccess', 'success', productData.length);
                    renderPreview();
                } catch (error) {
                    addStatusMessage('statusParseFailed', 'error', error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        async function processImageFiles(files, targetObject, nameSpan) {
            userHasUploaded = true;
            if (files.length === 0) {
                nameSpan.textContent = getTranslation('noFilesChosen');
                return;
            }
            nameSpan.textContent = `${files.length} ${getTranslation('filesSelected') || 'files selected'}`;
            clearStatus();
            addStatusMessage('statusProcessingImages', 'info');
            
            Object.keys(targetObject).forEach(key => URL.revokeObjectURL(targetObject[key]));
            for (const key in targetObject) { delete targetObject[key]; }

            let processedCount = 0;
            for (const file of files) {
                try {
                    const imageUrl = await handleImageUpload(file);
                    if (imageUrl) {
                        const fileName = file.name.split('.').slice(0, -1).join('.');
                        targetObject[fileName] = imageUrl;
                        processedCount++;
                    }
                } catch (error) {
                    addStatusMessage('statusImageProcessFailed', 'error', file.name);
                }
            }
            addStatusMessage('statusImagesSuccess', 'success', processedCount, files.length);
            renderPreview();
        }

        imageFilesInput.addEventListener('change', async (event) => {
            await processImageFiles(Array.from(event.target.files), productImages, document.getElementById('imageFilesName'));
        });

        originFlagFilesInput.addEventListener('change', async (event) => {
            await processImageFiles(Array.from(event.target.files), originImages, document.getElementById('originFlagFilesName'));
        });

        async function setupImageInput(inputId, urlVariableSetter, imageTypeName, skipCompression = false) {
            const input = document.getElementById(inputId);
            input.addEventListener('change', async (event) => {
                userHasUploaded = true;
                const file = event.target.files[0];
                const fileNameSpan = document.getElementById(inputId + 'Name');
                if (!file) {
                    fileNameSpan.textContent = getTranslation('noFileChosen');
                    urlVariableSetter('');
                    renderPreview();
                    return;
                }
                fileNameSpan.textContent = file.name;
                try {
                    const url = await handleImageUpload(file, skipCompression);
                    urlVariableSetter(url);
                    renderPreview();
                } catch (error) {
                    addStatusMessage('statusImageLoadFailed', 'error', imageTypeName, error.message);
                }
            });
        }

        setupImageInput('backgroundFile', url => backgroundUrl = url, '背景图片');
        setupImageInput('logoFile', url => logoUrl = url, 'logo图片');
        setupImageInput('priceTagFile', url => priceTagUrl = url, '价格标签图片');
        setupImageInput('footerLogoFile', url => footerLogoUrl = url, '页脚logo图片');
        setupImageInput('headerBackgroundFile', url => headerBackgroundUrl = url, '页眉背景', true);

        promoTimeInput.addEventListener('input', debounce(renderPreview, 300));
        promoTextInput.addEventListener('input', debounce(renderPreview, 300));
        newArrivalsTextInput.addEventListener('input', debounce(renderPreview, 300));
        footerTextInput.addEventListener('input', debounce(renderPreview, 300));

        printBtn.addEventListener('click', () => window.print());

        downloadTemplateBtn.addEventListener('click', () => {
            const templateData = [{ page: 1, sku: '2327', name: 'Coconut Milk', size: '6x2900ml', brand: 'Aroy-D', origin: 'Thailand,Vietnam', price: 83.90, bbd: '2026-12-31', unit: 'st', remark: 'Hot Sale' }];
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Products');
            XLSX.writeFile(wb, 'catalog_template.xlsx');
        });

        // Initial setup
        setLanguage(currentLang);
        checkAccess();
    });
    </script>
</body>
</html>